<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calculadora</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="card">
    <h1>Calculadora</h1>
    <form id="calcForm">

        <!-- Selector de modo — igual que Swing con showOptionDialog -->
        <div class="field">
            <label>Modo de entrada</label>
            <select name="inputMode" id="inputMode" onchange="toggleMode()">
                <option value="string">Texto separado por coma (ej: 3.5,2)</option>
                <option value="integer">Dos campos enteros</option>
            </select>
        </div>

        <!-- Modo string: un solo campo, StringToDoubleAdapter en backend -->
        <div id="modeString">
            <div class="field">
                <label>Operandos</label>
                <input type="text"
                       id="fieldComma"
                       placeholder="3.5,2">
                <small style="color:#888">Dos números separados por coma</small>
            </div>
        </div>

        <!-- Modo integer: dos campos separados, IntegerToDoubleAdapter en backend -->
        <div id="modeInteger" style="display:none">
            <div class="field">
                <label>Primer entero</label>
                <input type="number" id="fieldA" step="1">
            </div>
            <div class="field">
                <label>Segundo entero</label>
                <input type="number" id="fieldB" step="1">
            </div>
        </div>

        <!-- Campo oculto — siempre envía "número,número" al controller -->
        <input type="hidden" name="operands" id="operands">

        <div class="field">
            <label>Operación</label>
            <select name="operation">
                <option value="add">Suma</option>
                <option value="subtract">Resta</option>
                <option value="multiplication">Multiplicación</option>
                <option value="division">División</option>
                <option value="legacy-add">Suma (legacy)</option>
            </select>
        </div>

        <button type="submit">Calcular</button>
    </form>

    <div id="output"></div>
</div>

<script>
    // Alterna la vista igual que Swing alterna entre adapters
    function toggleMode() {
        const mode = document.getElementById('inputMode').value;
        document.getElementById('modeString').style.display  = mode === 'string'  ? 'block' : 'none';
        document.getElementById('modeInteger').style.display = mode === 'integer' ? 'block' : 'none';
    }

    document.getElementById('calcForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const mode = document.getElementById('inputMode').value;
        let operandsValue;

        if (mode === 'integer') {
            // Dos campos enteros → construye "a,b" para que
            // IntegerToDoubleAdapter lo procese en el backend
            const a = document.getElementById('fieldA').value.trim();
            const b = document.getElementById('fieldB').value.trim();

            if (!a || !b) {
                showError('Completa ambos campos enteros.');
                return;
            }
            if (!Number.isInteger(Number(a)) || !Number.isInteger(Number(b))) {
                showError('En modo entero solo se permiten números sin decimales.');
                return;
            }

            operandsValue = `${a},${b}`;

        } else {
            // Campo de texto → pasa directo a StringToDoubleAdapter en backend
            const raw = document.getElementById('fieldComma').value.trim();

            if (!raw) {
                showError('Ingresa los operandos.');
                return;
            }

            const parts = raw.split(',');
            if (parts.length !== 2 || parts.some(p => p.trim() === '')) {
                showError('Formato inválido. Usa: número,número (ej: 3.5,2)');
                return;
            }

            operandsValue = raw;
        }

        // Inyecta el valor en el campo oculto antes de enviar
        document.getElementById('operands').value = operandsValue;

        const params = new URLSearchParams(new FormData(e.target));
        const response = await fetch('/calculate', {
            method: 'POST',
            body: params
        });

        document.getElementById('output').innerHTML = await response.text();
    });

    function showError(msg) {
        document.getElementById('output').innerHTML =
            `<div class="result">
                <span class="label">Error</span>
                <span class="value">${msg}</span>
             </div>`;
    }
</script>
</body>
</html>